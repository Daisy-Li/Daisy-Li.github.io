---
title: HTTP小记
tags: 
  - 网络
  - HTTP
categories:
  - 网络
keywords: "http"
date: 2021-10-12 15:00:00
top_img: https://cdn.jsdelivr.net/gh/Daisy-Li/image-cloud/http.jpeg
cover: https://cdn.jsdelivr.net/gh/Daisy-Li/image-cloud/http.jpeg
---

## HTTP1

### HTTP1缺点

1.  高延迟 — 队头阻塞(Head-Of-Line Blocking)
2.  无状态特性 — 阻碍交互
3.  明文传输 — 不安全性
4.  不支持服务端推送

PS:
1. `队头阻塞`是指当顺序发送的请求序列中的一个请求因为某种原因被阻塞时，在后面排队的所有请求也一并被阻塞，会导致客户端迟迟收不到数据；
2. `无状态是指协议对于连接状态没有记忆能力`。纯净的 HTTP 是没有 cookie 等机制的，每一个连接都是一个新的连接。 Header里携带的内容过多，”大头儿子“；
3. HTTP/1.1在传输数据时，所有`传输的内容都是明文`，客户端和服务器端都无法验证对方的身份，这在一定程度上无法保证数据的安全性。
4. 只能从客户端向服务器端发起请求。

### SPDY协议

谷歌公开了自行研发的 SPDY 协议，主要解决HTTP/1.1效率不高的问题。HTTP1.1主要问题就是安全不足和性能不高。

## HTTP2

### HTTP2新特性

1. 二进制传输

HTTP/2 将请求和响应数据分割为更小的帧，并且它们采用二进制编码，二进制协议解析起来更高效。
HTTP/2 中，同域名下所有通信都在单个连接上完成，该连接可以承载任意数量的双向数据流。每个数据流都以消息的形式发送，而消息又由一个或多个帧组成。**多个帧之间可以乱序发送，根据帧首部的流标识可以重新组装**。

2. Header压缩

HTTP/2在客户端和服务器两端建立“字典”，用索引号表示重复的字符串，还采用霍夫曼编码来压缩整数和字符串，可以达到50%~90%的高压缩率。
在客户端和服务器端使用“首部表”来跟踪和存储之前发送的键-值对，对于相同的数据，不再通过每次请求和响应发送；
例如下图中的两个请求，请求一发送了所有的头部字段，第二个请求则只需要发送差异数据，这样可以减少冗余数据，降低开销。

![5ba24e56c7c84bfda6b382cb08090961_tplv-k3u1fbpfcp-watermark.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cbd383ad270241bba902ada8bf7fa5dd~tplv-k3u1fbpfcp-watermark.image?)

3. 多路复用

在 HTTP/2 中，有了二进制分帧之后，HTTP /2 不再依赖 TCP 链接去实现多流并行了，在 HTTP/2中:

-   同域名下所有通信都在单个连接上完成。
-   单个连接可以承载任意数量的双向数据流。
-   数据流以消息的形式发送，而消息又由一个或多个帧组成，多个帧之间可以乱序发送，因为根据帧首部的流标识可以重新组装。

- **同个域名只需要占用一个 TCP 连接**，使用一个连接并行发送多个请求和响应,这样整个页面资源的下载过程只需要一次慢启动，同时也避免了多个TCP连接竞争带宽所带来的问题。
- 并行交错地发送多个请求/响应，请求/响应之间互不影响。
- 在HTTP/2中，每个请求都可以带一个31bit的优先值，0表示最高优先级， 数值越大优先级越低。有了这个优先值，客户端和服务器就可以在处理不同的流时采取不同的策略，以最优的方式发送流、消息和帧。

ps: 由浏览器根据资源类型、在发起 GET 请求时自动向 HTTP/2 的 PRIORITY 帧中追加优先级信息，对前端开发者来说是不透明的。但大体来说都是 HTML > CSS > Blocking Script > Font >= Image >= Async Script。

4. Server Push 服务端推送

比如，在浏览器刚请求HTML的时候就提前把可能会用到的JS、CSS文件发给客户端，减少等待的延迟，这被称为"`服务器推送`"（ Server Push，也叫 Cache push）
服务端可以主动推送，客户端也有权利选择是否接收。如果服务端推送的资源已经被浏览器缓存过，浏览器可以通过发送RST_STREAM帧来拒收。主动推送也遵守同源策略，换句话说，服务器不能随便将第三方资源推送给客户端，而必须是经过双方确认才行。

5. 提高安全性

出于兼容的考虑，HTTP/2延续了HTTP/1的“明文”特点，可以像以前一样使用明文传输数据，不强制使用加密通信，不过格式还是二进制，只是不需要解密。

但由于HTTPS已经是大势所趋，而且主流的浏览器Chrome、Firefox等都公开宣布只支持加密的HTTP/2，**所以“事实上”的HTTP/2是加密的**。也就是说，互联网上通常所能见到的HTTP/2都是使用"https”协议名，跑在TLS上面。HTTP/2协议定义了两个字符串标识符：“h2"表示加密的HTTP/2，“h2c”表示明文的HTTP/2。

### HTTP/2 的缺点

**主要是底层支撑的 TCP 协议造成的**

1. TCP 以及 TCP+TLS 建立连接的延时（三次握手，TLS链接建立）
2. TCP 的队头阻塞并没有彻底解决（丢包问题）
3. 多路复用导致服务器压力上升
4. 多路复用容易 Timeout

`RTT（Round-Trip Time）`:
往返时延。表示从发送端发送数据开始，到发送端收到来自接收端的确认（接收端收到数据后便立即发送确认），总共经历的时延。

HTTP/2出现丢包时，整个 TCP 都要开始等待重传，那么就会阻塞该TCP连接中的所有请求（如下图）。而对于 HTTP/1.1 来说，可以开启多个 TCP 连接，出现这种情况反到只会影响其中一个连接，剩余的 TCP 连接还可以正常传输数据。

多路复用没有限制同时请求数。请求的平均数量与往常相同，但实际会有许多请求的短暂爆发，导致瞬时 QPS 暴增。

大批量的请求同时发送，由于 HTTP2 连接内存在多个并行的流，而网络带宽和服务器资源有限，每个流的资源会被稀释，虽然它们开始时间相差更短，但却都可能超时。

## HTTP/3 新特性

![1.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5f27db24a7974af89f73b92bbb794d0e~tplv-k3u1fbpfcp-watermark.image?)

真正“完美”地解决了“队头阻塞”问题。

1. 实现了快速握手功能 **0RTT 建连可以说是 QUIC 相比 HTTP2 最大的性能优势**；
2. 集成了TLS加密功能
3. 多路复用，彻底解决TCP中队头阻塞的问题

和TCP不同，QUIC实现了在同一物理连接上可以有多个独立的逻辑数据流（如下图）。实现了数据流的单独传输，就解决了TCP中队头阻塞的问题。

## 总结

- HTTP/1.1有两个主要的缺点：安全不足和性能不高。
- HTTP/2完全兼容HTTP/1，是“更安全的HTTP、更快的HTTPS"，二进制传输、头部压缩、多路复用、服务器推送等技术可以充分利用带宽，降低延迟，从而大幅度提高上网体验；
- QUIC 基于 UDP 实现，是 HTTP/3 中的底层支撑协议，该协议基于 UDP，又取了 TCP 中的精华，实现了即快又可靠的协议。

## 参考
https://juejin.cn/post/6995109407545622542